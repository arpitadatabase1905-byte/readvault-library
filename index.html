<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üìö ReadVault</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      padding: 20px;
    }
    h1 { text-align: center; }
    #authSection, #librarySection { max-width: 800px; margin: auto; }
    #librarySection { display: none; }
    .search-bar { text-align: center; margin-bottom: 20px; }
    .search-bar input { padding: 8px; width: 60%; margin-right: 10px; }
    .search-bar button { padding: 8px 12px; }
    #bookList, #searchResults { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 15px; padding: 0; list-style: none; }
    .book-card {
      display: flex; flex-direction: column; align-items: center;
      border: 1px solid #ddd; padding: 10px; border-radius: 8px;
      background: #fff; box-shadow: 0px 2px 5px rgba(0,0,0,0.1);
    }
    .book-cover { width: 100px; height: auto; border-radius: 4px; margin-bottom: 10px; }
    .book-title { font-weight: bold; margin: 5px 0; text-align: center; }
    .book-author, .book-isbn { font-size: 0.9em; margin: 2px 0; color: #555; text-align: center; }
    .book-actions { margin-top: 10px; }
    .book-actions button { margin: 0 5px; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: #fff; }
    .book-actions button.deleteBtn { background: #dc3545; }
    #logoutBtn { display: block; margin: 20px auto; padding: 10px 20px; background:#1a73e8; color:#fff; border:none; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>

<h1>üìö ReadVault</h1>

<!-- Auth Section -->
<div id="authSection">
  <button id="loginBtn">Login with Google</button>
</div>

<!-- Library Section -->
<div id="librarySection">
  <!-- Search -->
  <div class="search-bar">
    <input type="text" id="searchTitle" placeholder="Book Name">
    <button id="searchBtn">Search</button>
  </div>
  <div id="searchResults"></div>

  <h2>üìñ My Library</h2>
  <ul id="bookList"></ul>

  <button id="logoutBtn">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc, addDoc } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDRIOLQBYUVU0LopAW077qCkvkp6TAboj8",
  authDomain: "readvault-58040.firebaseapp.com",
  projectId: "readvault-58040",
  storageBucket: "readvault-58040.appspot.com",
  messagingSenderId: "735101113966",
  appId: "1:735101113966:web:73583ee54e9ac092f3b87f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
const db = getFirestore(app);

// DOM Elements
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const authSection = document.getElementById("authSection");
const librarySection = document.getElementById("librarySection");
const bookList = document.getElementById("bookList");
const searchTitle = document.getElementById("searchTitle");
const searchBtn = document.getElementById("searchBtn");
const searchResultsDiv = document.getElementById("searchResults");

let currentUser = null;

// Login
loginBtn.addEventListener("click", async () => {
  await signInWithPopup(auth, provider);
});

// Logout
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
});

// Auth state
onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser = user;
    authSection.style.display = "none";
    librarySection.style.display = "block";
    loadBooks(user.uid);
  } else {
    currentUser = null;
    authSection.style.display = "block";
    librarySection.style.display = "none";
    bookList.innerHTML = "";
    searchResultsDiv.innerHTML = "";
  }
});

// Load library books
async function loadBooks(uid){
  bookList.innerHTML = "";
  const snapshot = await getDocs(collection(db,"users",uid,"books"));
  let books = [];
  snapshot.forEach(docItem=>books.push({ id: docItem.id, ...docItem.data() }));
  books.sort((a,b)=>a.name.toLowerCase().localeCompare(b.name.toLowerCase()));
  
  books.forEach(book=>{
    const li = document.createElement("li");
    li.innerHTML = `
      <div class="book-card">
        <img src="${book.cover || 'https://via.placeholder.com/100'}" class="book-cover">
        <p class="book-title">${book.name}</p>
        <p class="book-author">by ${book.author || "Unknown"}</p>
        <p class="book-isbn">ISBN: ${book.isbn}</p>
        <div class="book-actions">
          <button class="editBtn">‚úèÔ∏è Edit</button>
          <button class="deleteBtn">üóëÔ∏è Delete</button>
        </div>
      </div>
    `;
    
    // Edit
    li.querySelector(".editBtn").addEventListener("click", async ()=>{
      const newName = prompt("Enter new book title:", book.name);
      const newAuthor = prompt("Enter new author:", book.author||"Unknown");
      const newISBN = prompt("Enter new ISBN:", book.isbn);
      if(newName && newAuthor && newISBN){
        try{
          await updateDoc(doc(db,"users",uid,"books",book.id),{name:newName,author:newAuthor,isbn:newISBN});
          loadBooks(uid);
        } catch(err){ alert("Update failed: "+err.message); }
      }
    });
    
    // Delete
    li.querySelector(".deleteBtn").addEventListener("click", async ()=>{
      if(confirm(`Delete "${book.name}"?`)){
        await deleteDoc(doc(db,"users",uid,"books",book.id));
        loadBooks(uid);
      }
    });

    bookList.appendChild(li);
  });
}

// Google Books search
searchBtn.addEventListener("click", async ()=>{
  const query = searchTitle.value.trim();
  if(!query) return alert("Enter a book name");
  searchResultsDiv.innerHTML = "Searching...";
  
  try{
    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}`);
    const data = await response.json();
    searchResultsDiv.innerHTML = "";
    if(!data.items || data.items.length===0){
      searchResultsDiv.innerHTML="No books found.";
      return;
    }
    
    data.items.forEach(item=>{
      const book = item.volumeInfo;
      const title = book.title || "Unknown title";
      const authors = book.authors ? book.authors.join(", ") : "Unknown author";
      const isbn = book.industryIdentifiers ? book.industryIdentifiers[0].identifier : "N/A";
      const thumbnail = book.imageLinks ? book.imageLinks.thumbnail : "";

      const div = document.createElement("div");
      div.classList.add("book-card");
      div.innerHTML = `
        <img src="${thumbnail}" class="book-cover">
        <p class="book-title">${title}</p>
        <p class="book-author">by ${authors}</p>
        <p class="book-isbn">ISBN: ${isbn}</p>
        <button class="addBtn">Add to Library</button>
      `;

      div.querySelector(".addBtn").addEventListener("click", async ()=>{
        if(!currentUser) return alert("Login first!");
        await addDoc(collection(db,"users",currentUser.uid,"books"),{
          name:title,
          author:authors,
          isbn:isbn,
          cover:thumbnail
        });
        alert(`Added "${title}"`);
        loadBooks(currentUser.uid);
      });

      searchResultsDiv.appendChild(div);
    });

  } catch(err){
    searchResultsDiv.innerHTML="Error fetching books.";
    console.error(err);
  }
});
</script>
</body>
</html>
